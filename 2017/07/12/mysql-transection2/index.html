<!DOCTYPE html><html lang="en"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description"><title>CH 4 트랜잭션(4.2, 4.3) | Wonny's note</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/normalize/6.0.0/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/0.6.2/pure-min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/0.6.2/grids-responsive-min.css"><link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.bootcss.com/jquery/3.2.1/jquery.min.js"></script><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><link rel="alternate" type="application/atom+xml" href="/feed.xml"><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
ga('create','UA-102438172-1','auto');ga('send','pageview');</script></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">CH 4 트랜잭션(4.2, 4.3)</h1><a id="logo" href="/.">Wonny's note</a><p class="description"></p></div><div id="nav-menu"><a href="/." class="current"><i class="fa fa-home"> Home</i></a><a href="/archives/"><i class="fa fa-archive"> Archive</i></a></div></div><div id="layout" class="pure-g"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">CH 4 트랜잭션(4.2, 4.3)</h1><div class="post-meta">Jul 12, 2017<span> | </span><span class="category"><a href="/categories/Mysql/">Mysql</a></span><script src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js" async></script><span id="busuanzi_container_page_pv"> | <span id="busuanzi_value_page_pv"></span><span> Hits</span></span></div><div class="post-content"><h2 id="4-2-Mysql-엔진의-잠금"><a href="#4-2-Mysql-엔진의-잠금" class="headerlink" title="4.2 Mysql 엔진의 잠금"></a>4.2 Mysql 엔진의 잠금</h2><p>Mysql 에서 사용되는 잠금은 크게 스토리지 엔진 레벨과 Mysql 엔진 레벨로 나눠볼 수 있다. Mysql 엔진은 Mysql 서버에서 스토리지 엔진을 제외한 나머지 부분으로 이해하면 되는데, Mysql 엔진 레벨의 잠금은 모든 스토리지 엔진에 영향을 미치게 되지만 스토리지 엔진 레벨의 잠금은 스토리지 엔진 간 상호 영향을 미치지 않는다.</p>
<h3 id="4-2-1-글로벌-락-Global-Lock"><a href="#4-2-1-글로벌-락-Global-Lock" class="headerlink" title="4.2.1 글로벌 락 (Global Lock)"></a>4.2.1 글로벌 락 (Global Lock)</h3><p>글로벌락은 “flush tables with read lock” 명령으로만 획득할 수 있으며, Mysql에서 제공하는 잠금 가운데 가장 범위가 크다. 글로벌 락이 영향을 미치는 범위는 Mysql 서버 전체이며, 작업 대상 테이블이나 데이터베이스가 다르다 하더라도 동일하게 영향을 미친다.</p>
<h3 id="4-2-2-테이블-락-Table-Lock"><a href="#4-2-2-테이블-락-Table-Lock" class="headerlink" title="4.2.2 테이블 락 (Table Lock)"></a>4.2.2 테이블 락 (Table Lock)</h3><p>개별 테이블 단위로 설정되는 잠금이며, 명시적 또는 묵시적으로 특정 테이블의 락을 획득할 수 있다. 명시적으로는 “lock tables table_name [READ | WRITE]” 명령으로 특정 테이블의 락을 획득할 수 있다. 테이블 락은 MyISAM뿐 아니라 InnoDB 스토리지 엔진을 사용하는 테이블도 동일하게 설정할 수 있다. 명시적으로 획득한 잠금은 “Unlock Tables” 명령으로 잠금을 반납(해제) 할 수 있다.</p>
<h3 id="4-2-3-유저-락-User-Lock"><a href="#4-2-3-유저-락-User-Lock" class="headerlink" title="4.2.3 유저 락 (User Lock)"></a>4.2.3 유저 락 (User Lock)</h3><p>Get_lock() 함수를 이용해 임의로 잠금을 설정할 수 있다. 이 잠금의 특징은 대상이 테이블이나 레코드 또는 Auto_increment 와 같은 데이터베이스 객체가 아니라는 것이다. 유저락은 단순히 사용자가 지정한 문자열에 대해 획득하고 반납하는 잠금이다. 여러 클라이언트가 상호 동기화를 처리해야 할때 데이터베이스의 유저 락을 이용하면 쉽게 해결할 수 있다.</p>
<p>또한 유저락은 많은 레코드를 한번에 변경해야 하는 트랜잭션의 경우에 유용하게 사용할 수 있다. 배치 프로그램처럼 한번에 많은 레코드를 변경하는 경우 데드락의 원인이 되곤 한다. 이때 동일한 데이터를 변경하는 프로그램끼리 분류해서 유저 락을 걸고 쿼리를 실행하면 아주 간단히 해결할 수 있다.</p>
<h3 id="4-2-4-네임-락-Name-Lock"><a href="#4-2-4-네임-락-Name-Lock" class="headerlink" title="4.2.4. 네임 락 (Name Lock)"></a>4.2.4. 네임 락 (Name Lock)</h3><p>데이터베이스 객체의 이름을 변경하는 경우 획득하는 잠금이다. 네임 락은 명시적으로 획득하거나 해제할 수 있는 것이 아니고 “Rename table tab_a To tab_b” 같은 테이블의 이름을 변경하는 경우 자동으로 획득하는 잠금이다. </p>
<h2 id="4-3-MyISAM-과-MEMORY-스토리지-엔진의-잠금"><a href="#4-3-MyISAM-과-MEMORY-스토리지-엔진의-잠금" class="headerlink" title="4.3 MyISAM 과 MEMORY 스토리지 엔진의 잠금"></a>4.3 MyISAM 과 MEMORY 스토리지 엔진의 잠금</h2><p>MyISAM 이나 MEMORY 스토리지 엔진은 자체적인 잠금을 가지지 않고 MYSQL 엔진에서 제공하는 테이블 락을 그대로 사용한다. 그리고 MyISAM 이나 MEMORY 스토리지 엔진에서는 쿼리 단위로 필요한 잠금을 한꺼번에 요청해서 획득하기 때문에 데드락이 발생할 수 없다. </p>
<h3 id="4-3-1-잠금-획득"><a href="#4-3-1-잠금-획득" class="headerlink" title="4.3.1 잠금 획득"></a>4.3.1 잠금 획득</h3><ul>
<li>읽기 잠금<br>테이블에 쓰기 잠금이 걸려 있지 않으면 바로 일기 잠금을 획득하고 읽기 작업을 시작할 수 있다.</li>
<li>쓰기 잠금<br>테이블에 아무런 잠금이 걸려있지 않아야만 쓰기 잠금을 획득할 수 있고, 그렇지 않다면 다른 잠금이 해제될 때까지 대기해야 한다.</li>
</ul>
<h3 id="4-3-2-잠금-튜닝"><a href="#4-3-2-잠금-튜닝" class="headerlink" title="4.3.2 잠금 튜닝"></a>4.3.2 잠금 튜닝</h3><p>테이블 락에 대한 작업 상황은 MYSQL 의 상태 변수를 통해 확인할 수 있다.</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">mysql&gt; show status like 'Table%';</div><div class="line"></div><div class="line">+-----------------------+---------+</div><div class="line">| Variable_name         | Value   |</div><div class="line">+-----------------------+---------+</div><div class="line">| Table_locks_immediate | 1551552 |</div><div class="line">| Table_locks_waited    | 15324   |</div><div class="line">+-----------------------+---------+</div></pre></td></tr></table></figure>
<p>Table_locks_immediate 는 다른 잠금이 풀리기를 기다리지 않고 바로 잠금을 획득한 횟수이며, Table_locks_waited 는 다른 잠금이 이미 해당 테이블을 사용하고 있어서 기다려야 했던 횟수를 누적해서 저장하고 있다.</p>
<blockquote>
<p>잠금 대기 쿼리 비율 = Table_locks_waited / (Table_locks_immediate + Table_locks_waited) * 100;</p>
</blockquote>
<p>위의 수치들을 대입해보면 약 1.31% 의 수치를 얻을 수 있으며, 이는 100개의 쿼리중 1개는 잠금 대기를 겪고 있다는 것을 알 수 있다.</p>
<h3 id="4-3-3-테이블-수준의-잠금-확인-및-해제"><a href="#4-3-3-테이블-수준의-잠금-확인-및-해제" class="headerlink" title="4.3.3 테이블 수준의 잠금 확인 및 해제"></a>4.3.3 테이블 수준의 잠금 확인 및 해제</h3><p>MYISAM 이나 MEMORY 등과 같은 스토리지 엔진을 사용하는 테이블은 모두 테이블 단위의 잠금이므로 테이블을 해제하지 않으면 다른 클라이언트에서 그 테이블을 사용하는 것이 불가능하다. MYSQL 에서 현재 어떤 테이블이 잠겨있는지 확인하는 방법을 알아보자</p>
<p>MYSQL에서 테이블의 잠금을 획득하는 방법은 LOCK TABLES 명령을 이용해 명시적으로 획득하는 방법과, 쿼리문을 통한 묵시적 잠금획득 방법이 있다. 명시적인 방법은 UNLOCK TABLES 명령으로 해제하기 전에는 자동으로 해제되지 않는다.</p>
<p>아무런 옵션 없이 SHOW OPEN TABLES 명령을 바로 실행하면 MYSQL 서버의 모든 테이블에 대해 잠금 여부를 보여주고, FROM DB명 을 추가하면 해당 DB에 생성된 테이블에 대해 잠금 상태를 표시한다. SHOW OPEN TABLES 명령의 결과로 출력되는 in_use 값은 해당 테이블을 잠그고 있는 클라이언트 수와 테이블의 잠금을 기다리는 클라이언트의 수까지 더해서 출력된다. 그리고 “Name_locked” 는 테이블 이름에 대한 네임 락이 걸려 있는지를 표시한다. </p>
<p>어떤 클라이언트의 커넥션이 잠금을 기다리고 있는지 보려면 SHOW PROCESSLIST 명령을 사용해야 한다. </p>
</div><script type="text/javascript" src="/js/share.js?v=0.0.0" async></script><a data-url="https://jumpegg.github.io/2017/07/12/mysql-transection2/" data-id="cj54rcg87000du0uf8zmkc51i" class="article-share-link">Share</a><div class="tags"><a href="/tags/transection/">transection</a></div><div class="post-nav"><a href="/2017/07/12/ionic-menu/" class="pre">ionic-menu</a><a href="/2017/07/12/mysql-transection1/" class="next">CH 4 트랜젝션(4.1)</a></div></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> Categories</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Hexo/">Hexo</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Mysql/">Mysql</a><span class="category-list-count">7</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/ionic2/">ionic2</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/문제해결/">문제해결</a><span class="category-list-count">1</span></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> Tags</i></div><div class="tagcloud"><a href="/tags/ionic2-nav/" style="font-size: 15px;">ionic2-nav</a> <a href="/tags/Mysql/" style="font-size: 15px;">Mysql</a> <a href="/tags/transection/" style="font-size: 15px;">transection</a> <a href="/tags/ionic-root/" style="font-size: 15px;">ionic-root</a> <a href="/tags/ionic2-menu/" style="font-size: 15px;">ionic2-menu</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> Recent</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2017/07/15/mysql-transection3/">CH 4 트랜잭션(4.4, 4.5)</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/07/13/ionic-problem-01/">ionic root nav 문제해결</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/07/12/ionic-menu/">ionic-menu</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/07/12/mysql-transection2/">CH 4 트랜잭션(4.2, 4.3)</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/07/12/mysql-transection1/">CH 4 트랜젝션(4.1)</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/07/09/Ionic-nav-guard/">Ionic Guard 구현</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/07/08/Mysql-architecture4/">3. Mysql 아키텍처(3.7, 3.8)</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/07/08/Mysql-architecture3/">3. Mysql 아키텍처(3.4, 3.5, 3.6)</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/07/08/Mysql-architecture2/">3. Mysql 아키텍처(3.2, 3.3)</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/07/08/Mysql-architecture/">3. Mysql 아키텍쳐(3.1)</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> Links</i></div><ul></ul><a href="http://textshare.io" title="textshare.io" target="_blank">textshare.io</a></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2017 <a href="/." rel="nofollow">Wonny's note.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a id="rocket" href="#top" class="show"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//cdn.bootcss.com/fancybox/3.0.47/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/fancybox/3.0.47/jquery.fancybox.min.css"><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>